{% extends "base.html" %}
{% block title %}Finalize — Music for Yoto Player{% endblock %}

{% block steps %}
<div class="steps">
    <div class="step done"><div class="step-dot"></div> Build</div>
    <span class="step-arrow">›</span>
    <div class="step done"><div class="step-dot"></div> Review</div>
    <span class="step-arrow">›</span>
    <div class="step done"><div class="step-dot"></div> Match</div>
    <span class="step-arrow">›</span>
    <div class="step done"><div class="step-dot"></div> Download</div>
    <span class="step-arrow">›</span>
    <div class="step active"><div class="step-dot"></div> Finalize</div>
    <span class="step-arrow">›</span>
    <div class="step"><div class="step-dot"></div> Yoto</div>
</div>
{% endblock %}

{% block content %}
<div class="card">
    <h2>Finalize Your Playlist</h2>
    <p style="margin-bottom: 1rem;">
        <span class="text-success">{{ success_count }}</span> /
        {{ total }} songs downloaded successfully.
    </p>

    <ol class="song-list" id="resultsList">
        {% for r in results %}
        <li draggable="true" data-index="{{ loop.index0 }}" data-success="{{ 'true' if r.success else 'false' }}">
            <span class="drag-handle" title="Drag to reorder">☰</span>
            <span class="track-info" style="flex: 1; min-width: 0;">
                <span class="track-display">
                    <span class="song-title">{{ r.title }}</span>
                    <span class="song-artist"> — {{ r.artist }}</span>
                </span>
                <span class="track-edit" style="display: none;">
                    <input type="text" class="edit-title" value="{{ r.title }}"
                           placeholder="Song title" style="margin-bottom: 0.35rem;">
                    <input type="text" class="edit-artist" value="{{ r.artist }}"
                           placeholder="Artist" style="margin-bottom: 0.35rem;">
                    <div style="display: flex; gap: 0.35rem;">
                        <button onclick="saveTrack(this)" class="btn btn-primary" style="padding: 0.3rem 0.75rem; font-size: 0.8rem;">Save</button>
                        <button onclick="cancelEdit(this)" class="btn btn-secondary" style="padding: 0.3rem 0.75rem; font-size: 0.8rem;">Cancel</button>
                    </div>
                </span>
            </span>
            <span class="track-actions" style="margin-left: auto; flex-shrink: 0; display: flex; align-items: center; gap: 0.35rem;">
                {% if r.success %}
                    <span class="text-success">✓</span>
                {% else %}
                    <span class="text-danger">Failed</span>
                {% endif %}
                {% if r.success %}
                <button class="action-btn edit-btn" title="Edit title/artist" onclick="editTrack(this)">✎</button>
                {% endif %}
                <button class="action-btn rematch-btn" title="Re-match on YouTube" onclick="rematchTrack(this)">↻</button>
                <button class="action-btn delete-btn" title="Remove" onclick="deleteTrack(this)">×</button>
            </span>
        </li>
        {% endfor %}
    </ol>
    <p class="text-muted text-sm" style="margin-top: 0.5rem;">
        Drag to reorder. ✎ edit name · ↻ re-match · × remove.
    </p>
</div>

<div class="text-center mt-2">
    {% if yoto_available and success_count > 0 %}
    <a href="/yoto" class="btn btn-primary">Upload to Yoto</a>
    {% endif %}
    <a href="/" class="btn btn-secondary">Start New Playlist</a>
</div>
{% endblock %}

{% block scripts %}
<style>
    .track-edit input[type="text"] { font-size: 0.85rem; padding: 0.35rem 0.5rem; }
    #resultsList li {
        position: relative;
        transition: background 0.15s;
        user-select: none;
    }
    #resultsList li.dragging { opacity: 0.4; background: #334155; }
    #resultsList li.drag-over { border-top: 2px solid #38bdf8; }
    .drag-handle {
        cursor: grab;
        color: #475569;
        font-size: 1rem;
        flex-shrink: 0;
    }
    .drag-handle:active { cursor: grabbing; }
    .action-btn {
        background: none;
        border: none;
        color: #64748b;
        font-size: 1.1rem;
        cursor: pointer;
        padding: 0.15rem 0.35rem;
        line-height: 1;
        border-radius: 4px;
    }
    .edit-btn:hover { color: #a78bfa; background: rgba(167,139,250,0.1); }
    .delete-btn:hover { color: #ef4444; background: rgba(239,68,68,0.1); }
    .rematch-btn:hover { color: #38bdf8; background: rgba(56,189,248,0.1); }
</style>
<script>
// ── Edit track name ──
function editTrack(btn) {
    var li = btn.closest('li');
    li.querySelector('.track-display').style.display = 'none';
    li.querySelector('.track-edit').style.display = '';
}

function cancelEdit(btn) {
    var li = btn.closest('li');
    li.querySelector('.track-edit').style.display = 'none';
    li.querySelector('.track-display').style.display = '';
}

function saveTrack(btn) {
    var li = btn.closest('li');
    var idx = parseInt(li.dataset.index, 10);
    var newTitle = li.querySelector('.edit-title').value.trim();
    var newArtist = li.querySelector('.edit-artist').value.trim();
    if (!newTitle || !newArtist) { alert('Title and artist are required.'); return; }

    btn.disabled = true;
    btn.textContent = 'Saving...';

    fetch('/track/rename', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ index: idx, title: newTitle, artist: newArtist })
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        btn.disabled = false;
        btn.textContent = 'Save';
        if (data.error) {
            alert('Error: ' + data.error);
            return;
        }
        li.querySelector('.song-title').textContent = newTitle;
        li.querySelector('.song-artist').textContent = ' — ' + newArtist;
        li.querySelector('.edit-title').value = newTitle;
        li.querySelector('.edit-artist').value = newArtist;
        li.querySelector('.track-edit').style.display = 'none';
        li.querySelector('.track-display').style.display = '';
    })
    .catch(function(err) {
        btn.disabled = false;
        btn.textContent = 'Save';
        alert('Failed: ' + err.message);
    });
}

// ── Delete track ──
function deleteTrack(btn) {
    var li = btn.closest('li');
    var idx = parseInt(li.dataset.index, 10);

    fetch('/track/delete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ index: idx })
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.error) { alert('Error: ' + data.error); return; }
        li.remove();
        reindexItems();
    })
    .catch(function(err) { alert('Failed: ' + err.message); });
}

// ── Re-match track ──
function rematchTrack(btn) {
    var li = btn.closest('li');
    var idx = parseInt(li.dataset.index, 10);

    fetch('/track/rematch', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ index: idx })
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.error) { alert('Error: ' + data.error); return; }
        window.location.href = data.redirect;
    })
    .catch(function(err) { alert('Failed: ' + err.message); });
}

// ── Drag and drop reorder ──
var resultsList = document.getElementById('resultsList');
var dragSrcEl = null;

function getResultItems() {
    return Array.from(resultsList.querySelectorAll('li'));
}

function reindexItems() {
    getResultItems().forEach(function(li, i) {
        li.setAttribute('data-index', i);
    });
}

function saveResultOrder() {
    var order = getResultItems().map(function(li) {
        return parseInt(li.dataset.index, 10);
    });
    fetch('/track/reorder', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ order: order })
    }).then(function() {
        // Re-index after server confirms
        reindexItems();
    });
}

resultsList.addEventListener('dragstart', function(e) {
    dragSrcEl = e.target.closest('li');
    if (!dragSrcEl) return;
    dragSrcEl.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/plain', '');
});

resultsList.addEventListener('dragover', function(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    var target = e.target.closest('li');
    if (!target || target === dragSrcEl) return;
    getResultItems().forEach(function(li) { li.classList.remove('drag-over'); });
    target.classList.add('drag-over');
});

resultsList.addEventListener('dragleave', function(e) {
    var target = e.target.closest('li');
    if (target) target.classList.remove('drag-over');
});

resultsList.addEventListener('drop', function(e) {
    e.preventDefault();
    var target = e.target.closest('li');
    if (!target || target === dragSrcEl) return;

    var items = getResultItems();
    var dragIdx = items.indexOf(dragSrcEl);
    var targetIdx = items.indexOf(target);

    if (dragIdx < targetIdx) {
        resultsList.insertBefore(dragSrcEl, target.nextSibling);
    } else {
        resultsList.insertBefore(dragSrcEl, target);
    }
    saveResultOrder();
});

resultsList.addEventListener('dragend', function() {
    getResultItems().forEach(function(li) {
        li.classList.remove('dragging');
        li.classList.remove('drag-over');
    });
    dragSrcEl = null;
});
</script>
{% endblock %}
