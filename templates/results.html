{% extends "base.html" %}
{% block title %}Results — Music Scraper for Yoto{% endblock %}

{% block steps %}
<div class="steps">
    <div class="step done"><div class="step-dot"></div> Build</div>
    <span class="step-arrow">›</span>
    <div class="step done"><div class="step-dot"></div> Review</div>
    <span class="step-arrow">›</span>
    <div class="step done"><div class="step-dot"></div> Match</div>
    <span class="step-arrow">›</span>
    <div class="step done"><div class="step-dot"></div> Download</div>
</div>
{% endblock %}

{% block content %}
<div class="card">
    <h2>Download Complete</h2>
    <p style="margin-bottom: 1rem;">
        <span class="text-success">{{ success_count }}</span> /
        {{ total }} songs downloaded successfully.
    </p>

    <ol class="song-list">
        {% for r in results %}
        <li>
            <span>
                <span class="song-title">{{ r.title }}</span>
                <span class="song-artist"> — {{ r.artist }}</span>
            </span>
            <span style="margin-left: auto;">
                {% if r.success %}
                    <span class="text-success">✓</span>
                {% else %}
                    <span class="text-danger">Failed</span>
                {% endif %}
            </span>
        </li>
        {% endfor %}
    </ol>
</div>

{% if yoto_available and success_count > 0 %}
<div class="card" id="yotoCard">
    <h2>Upload to Yoto</h2>
    <p class="text-muted text-sm" style="margin-bottom: 1rem;">
        Create a MYO card playlist with your downloaded songs.
    </p>

    {% if yoto_auth_error %}
    <p class="text-danger" style="margin-bottom: 1rem;">{{ yoto_auth_error }}</p>
    {% endif %}

    {% if yoto_authenticated %}
    <div id="yotoForm">
        <input type="text" id="cardName" placeholder="Playlist name (e.g. Bedtime Songs)"
               style="margin-bottom: 0.75rem;">
        <div style="margin-bottom: 0.75rem;">
            <label class="text-sm text-muted" style="display: block; margin-bottom: 0.35rem;">
                Card Icon
            </label>
            <select id="iconMode" style="width: 100%; padding: 0.5rem; border-radius: 6px;
                    border: 1px solid #334155; background: #1e293b; color: #e2e8f0;">
                <option value="public">Auto-select from Yoto public icons (AI picks best match)</option>
                <option value="generate">Generate custom 16x16 pixel art icon (AI created)</option>
            </select>
        </div>
        <button onclick="uploadToYoto()" class="btn btn-primary btn-block">
            Upload to Yoto &amp; Create MYO Card
        </button>
    </div>
    {% else %}
    <div id="yotoConnect">
        <p class="text-muted text-sm" style="margin-bottom: 0.75rem;">
            Connect your Yoto account to upload songs and create a MYO card.
        </p>
        <a href="/yoto/auth" class="btn btn-primary btn-block">
            Connect to Yoto
        </a>
    </div>
    {% endif %}

    <div id="yotoProgress" style="display: none;" class="text-center">
        <div class="spinner"></div>
        <p class="text-muted text-sm mt-1">Uploading to Yoto...</p>
    </div>

    <div id="yotoResult" style="display: none;"></div>
</div>
{% endif %}

<div class="text-center mt-2">
    <a href="/" class="btn btn-secondary">Start New Playlist</a>
</div>
{% endblock %}

{% block scripts %}
{% if yoto_available and success_count > 0 and yoto_authenticated %}
<script>
function uploadToYoto() {
    const name = document.getElementById('cardName').value.trim() || 'My Playlist';
    const iconMode = document.getElementById('iconMode').value;
    document.getElementById('yotoForm').style.display = 'none';
    document.getElementById('yotoProgress').style.display = 'block';

    const form = new FormData();
    form.append('card_name', name);
    form.append('icon_mode', iconMode);

    fetch('/yoto/upload', { method: 'POST', body: form })
        .then(r => r.json())
        .then(data => {
            document.getElementById('yotoProgress').style.display = 'none';
            const result = document.getElementById('yotoResult');
            result.style.display = 'block';

            if (data.success) {
                const iconMsg = data.iconSet
                    ? '<br>Card icon: set'
                    : '<br>Card icon: none (can be set in Yoto app)';
                result.innerHTML = `
                    <p class="text-success" style="font-weight: 500; margin-bottom: 0.5rem;">
                        MYO card created!
                    </p>
                    <p class="text-sm text-muted">
                        Card ID: ${data.cardId}<br>
                        Tracks uploaded: ${data.tracksUploaded}${iconMsg}<br><br>
                        Open the Yoto app to link this playlist to a physical MYO card.
                    </p>`;
            } else {
                result.innerHTML = `<p class="text-danger">${data.error}</p>`;
            }
        })
        .catch(err => {
            document.getElementById('yotoProgress').style.display = 'none';
            document.getElementById('yotoResult').style.display = 'block';
            document.getElementById('yotoResult').innerHTML =
                `<p class="text-danger">Upload failed: ${err.message}</p>`;
        });
}
</script>
{% endif %}
{% endblock %}
