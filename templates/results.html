{% extends "base.html" %}
{% block title %}Results — Music Scraper for Yoto{% endblock %}

{% block steps %}
<div class="steps">
    <div class="step done"><div class="step-dot"></div> Build</div>
    <span class="step-arrow">›</span>
    <div class="step done"><div class="step-dot"></div> Review</div>
    <span class="step-arrow">›</span>
    <div class="step done"><div class="step-dot"></div> Match</div>
    <span class="step-arrow">›</span>
    <div class="step done"><div class="step-dot"></div> Download</div>
</div>
{% endblock %}

{% block content %}
<div class="card">
    <h2>Download Complete</h2>
    <p style="margin-bottom: 1rem;">
        <span class="text-success">{{ success_count }}</span> /
        {{ total }} songs downloaded successfully.
    </p>

    <ol class="song-list">
        {% for r in results %}
        <li>
            <span>
                <span class="song-title">{{ r.title }}</span>
                <span class="song-artist"> — {{ r.artist }}</span>
            </span>
            <span style="margin-left: auto;">
                {% if r.success %}
                    <span class="text-success">✓</span>
                {% else %}
                    <span class="text-danger">Failed</span>
                {% endif %}
            </span>
        </li>
        {% endfor %}
    </ol>
</div>

{% if yoto_available and success_count > 0 %}
<div class="card" id="yotoCard">
    <h2>Upload to Yoto</h2>
    <p class="text-muted text-sm" style="margin-bottom: 1rem;">
        Create a MYO card playlist with your downloaded songs.
    </p>

    {% if yoto_auth_error %}
    <p class="text-danger" style="margin-bottom: 1rem;">{{ yoto_auth_error }}</p>
    {% endif %}

    {% if yoto_authenticated %}
    <div id="yotoForm">
        <div style="margin-bottom: 0.75rem;">
            <label class="text-sm text-muted" style="display: block; margin-bottom: 0.35rem;">
                Destination
            </label>
            <select id="cardTarget" onchange="onCardTargetChange()"
                    style="width: 100%; padding: 0.5rem; border-radius: 6px;
                    border: 1px solid #334155; background: #1e293b; color: #e2e8f0;">
                <option value="new">Create new MYO card</option>
            </select>
            <p id="cardCapacity" class="text-muted text-sm" style="margin-top: 0.35rem; display: none;"></p>
        </div>
        <input type="text" id="cardName" placeholder="Playlist name (e.g. Bedtime Songs)"
               style="margin-bottom: 0.75rem;">
        <div id="iconModeWrapper" style="margin-bottom: 0.75rem;">
            <label class="text-sm text-muted" style="display: block; margin-bottom: 0.35rem;">
                Card Icon
            </label>
            <select id="iconMode" style="width: 100%; padding: 0.5rem; border-radius: 6px;
                    border: 1px solid #334155; background: #1e293b; color: #e2e8f0;">
                <option value="public">Auto-select from Yoto public icons (AI picks best match)</option>
                <option value="generate">Generate custom 16x16 pixel art icon (AI created)</option>
            </select>
        </div>
        <button id="uploadBtn" onclick="uploadToYoto()" class="btn btn-primary btn-block">
            Upload to Yoto &amp; Create MYO Card
        </button>
    </div>
    {% else %}
    <div id="yotoConnect">
        <p class="text-muted text-sm" style="margin-bottom: 0.75rem;">
            Connect your Yoto account to upload songs and create a MYO card.
        </p>
        <a href="/yoto/auth" class="btn btn-primary btn-block">
            Connect to Yoto
        </a>
    </div>
    {% endif %}

    <div id="yotoProgress" style="display: none;" class="text-center">
        <div class="spinner"></div>
        <p id="yotoProgressText" class="text-muted text-sm mt-1">Uploading to Yoto...</p>
    </div>

    <div id="yotoResult" style="display: none;"></div>
</div>
{% endif %}

<div class="text-center mt-2">
    <a href="/" class="btn btn-secondary">Start New Playlist</a>
</div>
{% endblock %}

{% block scripts %}
{% if yoto_available and success_count > 0 and yoto_authenticated %}
<script>
var newSongsCount = {{ success_count }};
var existingCards = [];

// Fetch existing cards for the dropdown on page load
(function loadExistingCards() {
    fetch('/yoto/cards')
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.cards && data.cards.length > 0) {
                existingCards = data.cards;
                var select = document.getElementById('cardTarget');
                data.cards.forEach(function(c) {
                    var opt = document.createElement('option');
                    opt.value = c.cardId;
                    opt.textContent = c.title + ' (' + c.trackCount + ' tracks)';
                    opt.dataset.trackCount = c.trackCount;
                    opt.dataset.title = c.title;
                    select.appendChild(opt);
                });
            }
        })
        .catch(function() { /* ignore — dropdown just shows "Create new" */ });
})();

function onCardTargetChange() {
    var select = document.getElementById('cardTarget');
    var isNew = select.value === 'new';
    var capacity = document.getElementById('cardCapacity');
    var iconWrapper = document.getElementById('iconModeWrapper');
    var btn = document.getElementById('uploadBtn');
    var nameInput = document.getElementById('cardName');

    if (isNew) {
        capacity.style.display = 'none';
        iconWrapper.style.display = '';
        btn.textContent = 'Upload to Yoto & Create MYO Card';
        nameInput.value = '';
        nameInput.placeholder = 'Playlist name (e.g. Bedtime Songs)';
    } else {
        var opt = select.options[select.selectedIndex];
        var trackCount = parseInt(opt.dataset.trackCount) || 0;
        var available = 100 - trackCount;
        iconWrapper.style.display = 'none';
        btn.textContent = 'Upload & Add to Existing Card';
        nameInput.value = opt.dataset.title || '';

        if (available <= 0) {
            capacity.textContent = 'This card is full (100/100 tracks). Choose a different card.';
            capacity.className = 'text-danger text-sm';
            btn.disabled = true;
        } else if (newSongsCount > available) {
            capacity.textContent = 'This card has ' + trackCount + ' tracks with room for ' +
                available + ' more, but you have ' + newSongsCount +
                ' songs to add. Some may not fit.';
            capacity.className = 'text-danger text-sm';
            btn.disabled = true;
        } else {
            capacity.textContent = trackCount + '/100 tracks used — room for ' +
                available + ' more.';
            capacity.className = 'text-muted text-sm';
            btn.disabled = false;
        }
        capacity.style.display = '';
    }
}

function uploadToYoto() {
    var name = document.getElementById('cardName').value.trim() || 'My Playlist';
    var iconMode = document.getElementById('iconMode').value;
    var target = document.getElementById('cardTarget').value;
    document.getElementById('yotoForm').style.display = 'none';
    document.getElementById('yotoProgress').style.display = 'block';

    var form = new FormData();
    form.append('card_name', name);
    form.append('icon_mode', iconMode);
    if (target !== 'new') {
        form.append('existing_card_id', target);
    }

    fetch('/yoto/upload', { method: 'POST', body: form })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.error) {
                showUploadError(data.error);
                return;
            }
            if (data.job_id) {
                pollUploadStatus(data.job_id);
            }
        })
        .catch(function(err) { showUploadError('Upload failed: ' + err.message); });
}

function pollUploadStatus(jobId) {
    fetch('/yoto/upload/status?job_id=' + encodeURIComponent(jobId))
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.status === 'running') {
                var text = document.getElementById('yotoProgressText');
                if (data.current > 0 && data.total > 0) {
                    text.textContent = 'Uploading track ' + data.current +
                        ' of ' + data.total + ': ' + (data.current_title || '');
                }
                setTimeout(function() { pollUploadStatus(jobId); }, 2000);
            } else if (data.status === 'done' && data.result) {
                showUploadResult(data.result);
            } else if (data.status === 'error' && data.result) {
                showUploadError(data.result.error || 'Upload failed');
            } else {
                showUploadError('Unexpected status: ' + data.status);
            }
        })
        .catch(function() {
            setTimeout(function() { pollUploadStatus(jobId); }, 3000);
        });
}

function showUploadResult(data) {
    document.getElementById('yotoProgress').style.display = 'none';
    var result = document.getElementById('yotoResult');
    result.style.display = 'block';

    if (data.success) {
        var isUpdate = data.updated;
        var heading = isUpdate ? 'Tracks added to card!' : 'MYO card created!';
        var iconMsg = '';
        if (isUpdate) {
            iconMsg = '<br>Total tracks on card: ' + (data.totalTracks || data.tracksUploaded);
        } else {
            iconMsg = data.iconSet
                ? '<br>Card icon: set'
                : '<br>Card icon: none (can be set in Yoto app)';
        }
        result.innerHTML =
            '<p class="text-success" style="font-weight: 500; margin-bottom: 0.5rem;">' +
                heading +
            '</p>' +
            '<p class="text-sm text-muted">' +
                'Card ID: ' + data.cardId + '<br>' +
                'Tracks uploaded: ' + data.tracksUploaded + iconMsg + '<br><br>' +
                'Open the Yoto app to link this playlist to a physical MYO card.' +
            '</p>';
    } else {
        showUploadError(data.error || 'Unknown error');
    }
}

function showUploadError(msg) {
    document.getElementById('yotoProgress').style.display = 'none';
    document.getElementById('yotoForm').style.display = '';
    var result = document.getElementById('yotoResult');
    result.style.display = 'block';
    result.innerHTML = '<p class="text-danger">' + msg + '</p>';
}
</script>
{% endif %}
{% endblock %}
