{% extends "base.html" %}
{% block title %}Match Songs — Music for Yoto Player{% endblock %}

{% block steps %}
<div class="steps">
    <div class="step done"><div class="step-dot"></div> Build</div>
    <span class="step-arrow">›</span>
    <div class="step done"><div class="step-dot"></div> Review</div>
    <span class="step-arrow">›</span>
    <div class="step active"><div class="step-dot"></div> Match</div>
    <span class="step-arrow">›</span>
    <div class="step"><div class="step-dot"></div> Download</div>
</div>
{% endblock %}

{% block content %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        {% if is_rematch %}
        <h2 style="margin: 0;">Re-match Track</h2>
        <a href="/download/results" class="text-muted text-sm">Cancel &amp; go back</a>
        {% else %}
        <h2 style="margin: 0;">Song {{ current }} of {{ total }}</h2>
        <span class="text-muted text-sm">{{ confirmed_count }} confirmed</span>
        {% endif %}
    </div>
    {% if not is_rematch %}
    <div class="progress-bar">
        <div class="progress-fill" style="width: {{ (current / total * 100)|int }}%"></div>
    </div>
    {% endif %}

    <p style="margin: 1rem 0; font-size: 1rem;">
        Searching: <strong>"{{ query }}"</strong>
    </p>

    <div class="flex gap-sm" style="margin-bottom: 1rem;">
        <form action="/match" method="post" style="flex: 1;">
            <input type="hidden" name="action" value="retry">
            <div class="flex gap-sm">
                <input type="text" name="new_query" placeholder="Try different search..."
                       value="{{ query }}" style="flex: 1;">
                <button type="submit" class="btn btn-secondary">Retry</button>
            </div>
        </form>
        <form action="/match" method="post">
            <input type="hidden" name="action" value="skip">
            <button type="submit" class="btn btn-danger">{{ 'Cancel' if is_rematch else 'Skip' }}</button>
        </form>
    </div>

    {% if results %}
    <div>
        {% for r in results %}
        <div class="yt-result-wrapper" style="margin-bottom: 0.5rem;">
            <div style="display: flex; gap: 0.5rem; align-items: stretch;">
                <form action="/match" method="post" style="margin: 0; flex: 1;"
                      {% if r.downloaded %}onsubmit="return handleFileConflict(event, this, 'exact')"{% elif r.partial_match %}onsubmit="return handleFileConflict(event, this, 'partial')"{% endif %}>
                    <input type="hidden" name="action" value="select">
                    <input type="hidden" name="song_data" value='{{ r|tojson }}'>
                    <button type="submit" class="yt-result" style="width: 100%; height: 100%; text-align: left; background: #0f172a; color: #e2e8f0; border: 1px solid {% if r.downloaded %}#22c55e{% elif r.partial_match %}#eab308{% else %}#334155{% endif %}; font-family: inherit; font-size: inherit;">
                        {% if r.downloaded %}
                        <span style="display: inline-block; font-size: 0.65rem; font-weight: 600;
                                     background: #166534; color: #86efac; padding: 1px 6px;
                                     border-radius: 4px; margin-bottom: 3px; letter-spacing: 0.02em;">
                            DOWNLOADED
                        </span>
                        {% elif r.partial_match %}
                        <span style="display: inline-block; font-size: 0.65rem; font-weight: 600;
                                     background: #854d0e; color: #fde68a; padding: 1px 6px;
                                     border-radius: 4px; margin-bottom: 3px; letter-spacing: 0.02em;">
                            SIMILAR FILE: {{ r.partial_match }}
                        </span>
                        {% endif %}
                        <div class="song-title">{{ r.title }}</div>
                        <div class="song-artist">{{ r.artist }}
                            {% if r.album %}<span class="song-meta"> · {{ r.album }}</span>{% endif %}
                            {% if r.duration %}<span class="song-meta"> · {{ r.duration }}</span>{% endif %}
                        </div>
                    </button>
                </form>
                <button type="button" class="btn btn-secondary preview-btn"
                        data-video-id="{{ r.videoId }}"
                        style="padding: 0.6rem; border-radius: 8px; display: flex; align-items: center; justify-content: center; min-width: 44px;"
                        title="Preview">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><polygon points="5,3 19,12 5,21"/></svg>
                </button>
            </div>
            <div class="preview-player" style="display: none; margin-top: 0.35rem; border-radius: 8px; overflow: hidden;"></div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p class="text-muted">No results found for this search.</p>
    {% endif %}
</div>

<!-- Confirmation dialog for file conflicts -->
<div id="conflictDialog" style="display: none; position: fixed; inset: 0; z-index: 100;
        background: rgba(0,0,0,0.6); align-items: center; justify-content: center;">
    <div style="background: #1e293b; border: 1px solid #334155; border-radius: 12px;
                padding: 1.5rem; max-width: 420px; width: 90%; margin: auto;
                position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
        <h3 id="conflictTitle" style="margin: 0 0 0.5rem;"></h3>
        <p id="conflictFilename" class="text-sm" style="margin-bottom: 0.5rem; color: #94a3b8;
                word-break: break-all; font-family: monospace; background: #0f172a;
                padding: 0.35rem 0.5rem; border-radius: 4px;"></p>
        <p id="conflictMessage" class="text-muted text-sm" style="margin-bottom: 1rem;"></p>
        <div id="conflictButtons"></div>
        <button id="cancelConflictBtn" class="btn btn-secondary btn-block"
                style="margin-top: 0.5rem; font-size: 0.85rem;">
            Cancel
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function handleFileConflict(e, form, conflictType) {
    e.preventDefault();
    var dialog = document.getElementById('conflictDialog');
    var titleEl = document.getElementById('conflictTitle');
    var filenameEl = document.getElementById('conflictFilename');
    var messageEl = document.getElementById('conflictMessage');
    var buttonsEl = document.getElementById('conflictButtons');

    var songDataInput = form.querySelector('input[name="song_data"]');
    var songData = JSON.parse(songDataInput.value);

    // Build the filename that would be created
    var wouldCreate = songData.artist + ' - ' + songData.title + '.mp3';

    buttonsEl.innerHTML = '';

    if (conflictType === 'exact') {
        titleEl.textContent = 'File already exists';
        filenameEl.textContent = wouldCreate;
        messageEl.textContent = 'This exact filename is already in your downloads folder. ' +
            'It may be the same recording, or a different version (e.g. different album or remix).';

        var useBtn = document.createElement('button');
        useBtn.className = 'btn btn-primary';
        useBtn.style.cssText = 'flex: 1;';
        useBtn.textContent = 'Use existing file';
        useBtn.onclick = function() { dialog.style.display = 'none'; form.submit(); };

        var dlBtn = document.createElement('button');
        dlBtn.className = 'btn btn-secondary';
        dlBtn.style.cssText = 'flex: 1;';
        dlBtn.textContent = 'Re-download (overwrite)';
        dlBtn.onclick = function() {
            dialog.style.display = 'none';
            songData.force_download = true;
            songDataInput.value = JSON.stringify(songData);
            form.submit();
        };

        buttonsEl.style.cssText = 'display: flex; gap: 0.5rem;';
        buttonsEl.appendChild(useBtn);
        buttonsEl.appendChild(dlBtn);

    } else {
        // partial match
        titleEl.textContent = 'Similar file found';
        filenameEl.textContent = songData.partial_match;
        messageEl.textContent = 'A file with a similar name already exists. ' +
            'You can use it, or download this as a new file.';

        var useBtn = document.createElement('button');
        useBtn.className = 'btn btn-primary';
        useBtn.style.cssText = 'flex: 1;';
        useBtn.textContent = 'Use existing file';
        useBtn.onclick = function() {
            dialog.style.display = 'none';
            songData.use_existing = songData.partial_match;
            songDataInput.value = JSON.stringify(songData);
            form.querySelector('input[name="action"]').value = 'use_existing';
            form.submit();
        };

        var dlNewBtn = document.createElement('button');
        dlNewBtn.className = 'btn btn-secondary';
        dlNewBtn.style.cssText = 'flex: 1;';
        dlNewBtn.textContent = 'Download as new file';
        dlNewBtn.onclick = function() { dialog.style.display = 'none'; form.submit(); };

        buttonsEl.style.cssText = 'display: flex; gap: 0.5rem;';
        buttonsEl.appendChild(useBtn);
        buttonsEl.appendChild(dlNewBtn);
    }

    document.getElementById('cancelConflictBtn').onclick = function() {
        dialog.style.display = 'none';
    };

    dialog.style.display = 'flex';
    return false;
}

var playSvg = '<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><polygon points="5,3 19,12 5,21"/></svg>';
var stopSvg = '<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><rect x="4" y="4" width="16" height="16" rx="2"/></svg>';

function closePreview(btn, player) {
    player.style.display = 'none';
    player.innerHTML = '';
    btn.innerHTML = playSvg;
    btn.title = 'Preview';
    btn.style.background = '';
}

document.querySelectorAll('.preview-btn').forEach(function(btn) {
    btn.addEventListener('click', function(e) {
        e.stopPropagation();
        var wrapper = btn.closest('.yt-result-wrapper');
        var player = wrapper.querySelector('.preview-player');
        var videoId = btn.dataset.videoId;

        // Close any other open previews
        document.querySelectorAll('.yt-result-wrapper').forEach(function(w) {
            if (w !== wrapper) {
                var otherBtn = w.querySelector('.preview-btn');
                var otherPlayer = w.querySelector('.preview-player');
                if (otherPlayer.style.display !== 'none') {
                    closePreview(otherBtn, otherPlayer);
                }
            }
        });

        // Toggle this preview
        if (player.style.display === 'none') {
            var iframe = document.createElement('iframe');
            iframe.width = '100%';
            iframe.height = '80';
            iframe.style.border = 'none';
            iframe.allow = 'autoplay; encrypted-media';
            iframe.allowFullscreen = true;
            iframe.src = 'https://www.youtube-nocookie.com/embed/' + videoId + '?autoplay=1&origin=' + encodeURIComponent(window.location.origin);
            player.innerHTML = '';
            player.appendChild(iframe);
            player.style.display = 'block';
            btn.innerHTML = stopSvg;
            btn.title = 'Close preview';
            btn.style.background = '#dc2626';

            // Detect embed failure and show YouTube link fallback
            iframe.addEventListener('load', function() {
                try {
                    // Can't access cross-origin content, but we can detect errors via timeout
                } catch(e) {}
            });
            iframe.addEventListener('error', function() {
                showYouTubeFallback(player, videoId, btn);
            });
            // Fallback: if iframe loads but video shows error, provide a link after a short delay
            setTimeout(function() {
                if (player.style.display !== 'none' && player.querySelector('iframe')) {
                    var fallback = document.createElement('div');
                    fallback.style.cssText = 'text-align:center; padding:4px 0; font-size:12px;';
                    fallback.innerHTML = 'Not playing? <a href="https://www.youtube.com/watch?v=' + videoId + '" target="_blank" rel="noopener" style="color:#3b82f6; text-decoration:underline;">Open on YouTube</a>';
                    player.appendChild(fallback);
                }
            }, 2000);
        } else {
            closePreview(btn, player);
        }
    });
});
</script>
{% endblock %}
