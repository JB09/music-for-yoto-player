{% extends "base.html" %}
{% block title %}Match Songs — Music Scraper for Yoto{% endblock %}

{% block steps %}
<div class="steps">
    <div class="step done"><div class="step-dot"></div> Build</div>
    <span class="step-arrow">›</span>
    <div class="step done"><div class="step-dot"></div> Review</div>
    <span class="step-arrow">›</span>
    <div class="step active"><div class="step-dot"></div> Match</div>
    <span class="step-arrow">›</span>
    <div class="step"><div class="step-dot"></div> Download</div>
</div>
{% endblock %}

{% block content %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h2 style="margin: 0;">Song {{ current }} of {{ total }}</h2>
        <span class="text-muted text-sm">{{ confirmed_count }} confirmed</span>
    </div>
    <div class="progress-bar">
        <div class="progress-fill" style="width: {{ (current / total * 100)|int }}%"></div>
    </div>

    <p style="margin: 1rem 0; font-size: 1rem;">
        Searching: <strong>"{{ query }}"</strong>
    </p>

    {% if results %}
    <div style="margin-bottom: 1rem;">
        {% for r in results %}
        <div class="yt-result-wrapper" style="margin-bottom: 0.5rem;">
            <div style="display: flex; gap: 0.5rem; align-items: stretch;">
                <form action="/match" method="post" style="margin: 0; flex: 1;">
                    <input type="hidden" name="action" value="select">
                    <input type="hidden" name="song_data" value='{{ r|tojson }}'>
                    <button type="submit" class="yt-result" style="width: 100%; height: 100%; text-align: left; background: #0f172a; color: #e2e8f0; border: 1px solid #334155; font-family: inherit; font-size: inherit;">
                        <div class="song-title">{{ r.title }}</div>
                        <div class="song-artist">{{ r.artist }}
                            {% if r.album %}<span class="song-meta"> · {{ r.album }}</span>{% endif %}
                            {% if r.duration %}<span class="song-meta"> · {{ r.duration }}</span>{% endif %}
                        </div>
                    </button>
                </form>
                <button type="button" class="btn btn-secondary preview-btn"
                        data-video-id="{{ r.videoId }}"
                        style="padding: 0.6rem; border-radius: 8px; display: flex; align-items: center; justify-content: center; min-width: 44px;"
                        title="Preview">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><polygon points="5,3 19,12 5,21"/></svg>
                </button>
            </div>
            <div class="preview-player" style="display: none; margin-top: 0.35rem; border-radius: 8px; overflow: hidden;"></div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p class="text-muted">No results found for this search.</p>
    {% endif %}

    <div class="flex gap-sm mt-1">
        <form action="/match" method="post" style="flex: 1;">
            <input type="hidden" name="action" value="retry">
            <div class="flex gap-sm">
                <input type="text" name="new_query" placeholder="Try different search..."
                       value="{{ query }}" style="flex: 1;">
                <button type="submit" class="btn btn-secondary">Retry</button>
            </div>
        </form>
        <form action="/match" method="post">
            <input type="hidden" name="action" value="skip">
            <button type="submit" class="btn btn-danger">Skip</button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
var playSvg = '<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><polygon points="5,3 19,12 5,21"/></svg>';
var stopSvg = '<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><rect x="4" y="4" width="16" height="16" rx="2"/></svg>';

function closePreview(btn, player) {
    player.style.display = 'none';
    player.innerHTML = '';
    btn.innerHTML = playSvg;
    btn.title = 'Preview';
    btn.style.background = '';
}

document.querySelectorAll('.preview-btn').forEach(function(btn) {
    btn.addEventListener('click', function(e) {
        e.stopPropagation();
        var wrapper = btn.closest('.yt-result-wrapper');
        var player = wrapper.querySelector('.preview-player');
        var videoId = btn.dataset.videoId;

        // Close any other open previews
        document.querySelectorAll('.yt-result-wrapper').forEach(function(w) {
            if (w !== wrapper) {
                var otherBtn = w.querySelector('.preview-btn');
                var otherPlayer = w.querySelector('.preview-player');
                if (otherPlayer.style.display !== 'none') {
                    closePreview(otherBtn, otherPlayer);
                }
            }
        });

        // Toggle this preview
        if (player.style.display === 'none') {
            var iframe = document.createElement('iframe');
            iframe.width = '100%';
            iframe.height = '80';
            iframe.style.border = 'none';
            iframe.allow = 'autoplay; encrypted-media';
            iframe.allowFullscreen = true;
            iframe.src = 'https://www.youtube-nocookie.com/embed/' + videoId + '?autoplay=1&origin=' + encodeURIComponent(window.location.origin);
            player.innerHTML = '';
            player.appendChild(iframe);
            player.style.display = 'block';
            btn.innerHTML = stopSvg;
            btn.title = 'Close preview';
            btn.style.background = '#dc2626';

            // Detect embed failure and show YouTube link fallback
            iframe.addEventListener('load', function() {
                try {
                    // Can't access cross-origin content, but we can detect errors via timeout
                } catch(e) {}
            });
            iframe.addEventListener('error', function() {
                showYouTubeFallback(player, videoId, btn);
            });
            // Fallback: if iframe loads but video shows error, provide a link after a short delay
            setTimeout(function() {
                if (player.style.display !== 'none' && player.querySelector('iframe')) {
                    var fallback = document.createElement('div');
                    fallback.style.cssText = 'text-align:center; padding:4px 0; font-size:12px;';
                    fallback.innerHTML = 'Not playing? <a href="https://www.youtube.com/watch?v=' + videoId + '" target="_blank" rel="noopener" style="color:#3b82f6; text-decoration:underline;">Open on YouTube</a>';
                    player.appendChild(fallback);
                }
            }, 2000);
        } else {
            closePreview(btn, player);
        }
    });
});
</script>
{% endblock %}
