services:
  yoto-scraper:
    build:
      context: https://github.com/JB09/music-for-yoto-player.git
    ports:
      - "5000:5000"
    volumes:
      - ./downloads:/app/downloads
    networks:
      - backend
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - YOTO_CLIENT_ID=${YOTO_CLIENT_ID:-}
      - FLASK_SECRET_KEY=${FLASK_SECRET_KEY:-}
      - OUTPUT_DIR=/app/downloads
      # Music provider: "youtube" (default) or "plex"
      - MUSIC_PROVIDER=${MUSIC_PROVIDER:-youtube}
      # YouTube provider: yt-dlp-host sidecar (recommended)
      - DOWNLOAD_SERVICE_URL=${DOWNLOAD_SERVICE_URL:-http://ytdlp:5000}
      - DOWNLOAD_API_KEY=${DOWNLOAD_API_KEY:-}
      # Plex provider (only if MUSIC_PROVIDER=plex)
      - PLEX_URL=${PLEX_URL:-}
      - PLEX_TOKEN=${PLEX_TOKEN:-}
      - PLEX_MUSIC_LIBRARY=${PLEX_MUSIC_LIBRARY:-Music}
    depends_on:
      ytdlp:
        condition: service_started
        required: false

  # yt-dlp download service (user-provided, handles YouTube audio downloads)
  # The user chooses to run this service — it is not bundled with this project.
  # See: https://github.com/Vasysik/yt-dlp-host
  #
  # The dockerfile_inline below builds the yt-dlp-host image from the remote
  # repo and embeds an entrypoint script that reads DOWNLOAD_API_KEY from the
  # environment and writes it into yt-dlp-host's api_keys.json at startup.
  # This means you only need docker-compose.yml and .env — no repo clone needed.
  # See ytdlp-entrypoint.sh in this repo for a readable version of the script.
  ytdlp:
    build:
      context: https://github.com/Vasysik/yt-dlp-host.git
      dockerfile_inline: |
        FROM python:3.12-slim
        WORKDIR /app
        COPY . .
        RUN pip install --no-cache-dir -r requirements.txt
        RUN printf '#!/bin/sh\n\
        KEYS_FILE="/app/jsons/api_keys.json"\n\
        if [ -n "$$DOWNLOAD_API_KEY" ]; then\n\
            mkdir -p /app/jsons\n\
            cat > "$$KEYS_FILE" <<ENDOFKEYS\n\
        {\n\
            "admin": {\n\
                "key": "$$DOWNLOAD_API_KEY",\n\
                "permissions": [\n\
                    "create_key", "delete_key", "get_key", "get_keys",\n\
                    "get_video", "get_audio", "get_live_video", "get_live_audio", "get_info"\n\
                ],\n\
                "memory_quota": 5368709120,\n\
                "memory_usage": [],\n\
                "last_access": ""\n\
            }\n\
        }\n\
        ENDOFKEYS\n\
            echo "yt-dlp-host: API key configured from DOWNLOAD_API_KEY"\n\
        fi\n\
        exec flask run --host=0.0.0.0\n' > /app/entrypoint.sh && chmod +x /app/entrypoint.sh
    entrypoint: ["/app/entrypoint.sh"]
    volumes:
      - ytdlp-data:/app/downloads
    networks:
      - backend
    environment:
      - FLASK_APP=src.server:app
      - FLASK_RUN_HOST=0.0.0.0
      - DOWNLOAD_API_KEY=${DOWNLOAD_API_KEY:-}
    restart: unless-stopped
    profiles:
      - youtube

networks:
  backend:
    driver: bridge

volumes:
  ytdlp-data:
