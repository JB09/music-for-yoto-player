services:
  yoto-scraper:
    build: .
    ports:
      - "5000:5000"
    volumes:
      - ./downloads:/app/downloads
    networks:
      - backend
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - YOTO_CLIENT_ID=${YOTO_CLIENT_ID:-}
      - FLASK_SECRET_KEY=${FLASK_SECRET_KEY:-}
      - OUTPUT_DIR=/app/downloads
      # Music provider: "youtube" (default) or "plex"
      - MUSIC_PROVIDER=${MUSIC_PROVIDER:-youtube}
      # YouTube provider: yt-dlp-host sidecar (recommended)
      - DOWNLOAD_SERVICE_URL=${DOWNLOAD_SERVICE_URL:-http://ytdlp:5000}
      - DOWNLOAD_API_KEY=${DOWNLOAD_API_KEY:-}
      # Plex provider (only if MUSIC_PROVIDER=plex)
      - PLEX_URL=${PLEX_URL:-}
      - PLEX_TOKEN=${PLEX_TOKEN:-}
      - PLEX_MUSIC_LIBRARY=${PLEX_MUSIC_LIBRARY:-Music}
    depends_on:
      ytdlp:
        condition: service_started
        required: false

  # yt-dlp download service (user-provided, handles YouTube audio downloads)
  # The user chooses to run this service â€” it is not bundled with this project.
  # See: https://github.com/Vasysik/yt-dlp-host
  ytdlp:
    build:
      context: https://github.com/Vasysik/yt-dlp-host.git
    volumes:
      - ytdlp-data:/app/downloads
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        if [ -n "$$DOWNLOAD_API_KEY" ]; then
          mkdir -p /app/jsons
          printf '{"admin":{"key":"%s","permissions":["create_key","delete_key","get_key","get_keys","get_video","get_audio","get_live_video","get_live_audio","get_info"],"memory_quota":5368709120,"memory_usage":[],"last_access":""}}\n' "$$DOWNLOAD_API_KEY" > /app/jsons/api_keys.json
          echo "yt-dlp-host: API key configured from DOWNLOAD_API_KEY"
        fi
        exec flask run --host=0.0.0.0
    networks:
      - backend
    environment:
      - FLASK_APP=src.server:app
      - FLASK_RUN_HOST=0.0.0.0
      - DOWNLOAD_API_KEY=${DOWNLOAD_API_KEY:-}
    restart: unless-stopped
    profiles:
      - youtube

networks:
  backend:
    driver: bridge

volumes:
  ytdlp-data:
